---
import { markdownify } from "@/lib/utils/textConverter";
import ImageMod from "@/components/ImageMod.astro";
import { getCollection } from "astro:content";

const { testimonial } = Astro.props;

// Cargamos posts del blog
const allPosts = await getCollection("blog");

// QUITAMOS el archivo -index.md antes de todo
const posts = allPosts
  .filter((p) => p.data.slug !== "-index")   // üëà FILTRO IMPORTANTE
  .filter((p) => !p.data.draft)
  .sort((a, b) => (b.data.date?.valueOf() ?? 0) - (a.data.date?.valueOf() ?? 0))
  .slice(0, 5);


---



{
  testimonial.data.enable && (
    <section class="section">
      <div class="container">
        <div class="row">
          <div class="mx-auto mb-12 text-center md:col-10 lg:col-8 xl:col-6">
            <h2 set:html={markdownify(testimonial.data.title)} class="mb-4" />
            <p set:html={markdownify(testimonial.data.description)} />
          </div>

          <div class="col-12">
            <div class="swiper testimonial-slider">
              <div class="swiper-wrapper">
                {posts.map((post) => (
                  <div class="swiper-slide">
                    <a href={`/blog/${post.data.slug}`} class="block h-full">
                      <div class="relative overflow-hidden rounded-lg bg-light dark:bg-darkmode-light">

                        {/* Imagen del post ocupando toda la tarjeta */}
                        <ImageMod
                          height={450}
                          width={800}
                          class="h-64 w-full object-cover"
                          src={post.data.image ?? "/images/image-placeholder.png"}
                          alt={post.data.title}
                          format="webp"
                        />

                        {/* Degradado oscuro abajo para que se lea el texto */}
                        <div class="pointer-events-none absolute inset-0 bg-gradient-to-t from-black/70 via-black/20 to-transparent" />

                        {/* T√≠tulo y autor, como antes el nombre y el rol */}
                        <div class="pointer-events-none absolute inset-x-0 bottom-0 p-6">
                          <p class="text-xs font-medium uppercase tracking-wide text-gray-300">
                            {post.data.author}
                          </p>
                          <h3 class="mt-1 text-lg font-semibold text-white">
                            {post.data.title}
                          </h3>
                        </div>
                      </div>
                    </a>
                  </div>
                ))}
              </div>

              <div class="testimonial-slider-pagination mt-9 flex items-center justify-center text-center" />
            </div>
          </div>
        </div>
      </div>
    </section>
  )
}



<script>
  import { Swiper } from "swiper";
  import "swiper/css";
  import "swiper/css/pagination";
  import { Autoplay, Pagination } from "swiper/modules";

  const initSwiper = () => {
    const el = document.querySelector(".testimonial-slider");
    // Si no existe o ya est√° inicializado, no hacemos nada
    if (!el || el.swiper) return;

    new Swiper(el, {
      modules: [Pagination, Autoplay],
      spaceBetween: 24,
      loop: true,
      autoplay: {
        delay: 2500,
        disableOnInteraction: false,
      },
      pagination: {
        el: ".testimonial-slider-pagination",
        type: "bullets",
        clickable: true,
      },
      breakpoints: {
        0: {
          slidesPerView: 1,
        },
        768: {
          slidesPerView: 2,
        },
        992: {
          slidesPerView: 3,
        },
      },
    });
  };

  document.addEventListener("astro:page-load", initSwiper);
  document.addEventListener("astro:after-swap", initSwiper);
</script>

